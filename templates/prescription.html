{% extends 'base.html' %}

{% block title %}Prescription - Doctor App{% endblock %}

{% block content %}
<header class="page-header">
  <h1>Capture Conversation 🎙️</h1>
  <div class="audio-controls">
    <button id="refreshBtn" class="btn btn-secondary">🔄 New Session</button>
    <button id="startBtn" class="btn record-btn">Start Recording</button>
    <button id="stopBtn" class="btn" style="display:none;">Stop Recording</button>
    <span id="recordingIndicator" class="blink" style="display:none;">🔴 Recording...</span>
  </div>
</header>

<div class="content-container">
  
  <form id="prescriptionForm" class="card form-card" method="post" action="{% url 'prescription' %}">
    {% csrf_token %}
    
    <div class="form-grid">
      <div class="form-group"><label>Patient Name:</label><input type="text" name="patientName" required></div>
      <div class="form-group"><label>Phone:</label><input type="text" name="phone" required></div>
      <div class="form-group"><label>Age:</label><input type="number" name="age"></div>
      <div class="form-group"><label>Gender:</label><select name="gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
      <div class="form-group"><label>Blood Grp:</label><input type="text" name="bloodGrp"></div>
      <div class="form-group"><label>Weight:</label><input type="text" name="weight"></div>
      <div class="form-group"><label>BP:</label><input type="text" name="bp"></div>
    </div>

    <input type="hidden" name="transcriptionText" id="hiddenTranscriptionText">

    <h3 class="section-title">Symptoms Analysed:</h3>
    <div class="symptom-input-group">
      <input type="text" id="symptomInput" placeholder="Enter symptom">
      <button class="btn" type="button">Add Symptom</button>
    </div>
    <div class="symptoms-list" id="symptomsList"></div>

    <h3 class="section-title">Suggested Medicine:</h3>
    <div class="medicine-list" id="medicineList"></div>

    <!-- === UPDATED BUTTONS === -->
    <div class="action-buttons">
      <button class="btn" type="submit">✍️ Verify & Save</button>
      <button id="sendBtn" class="btn btn-secondary" type="button" disabled>📤 Send to Patient</button>
    </div>
    <p id="statusMessage" style="margin-top: 15px;"></p>

  </form>

  <div class="card ai-card">
    <h3>Suggested Medicine (AI)</h3>
    <div id="aiMedicineList">
       <p>AI suggestions will appear here after analysis.</p>
    </div>
    <hr>
    <h4>🎙️ Record Result:</h4>
    <audio id="audioPlayback" controls style="width:100%; margin-top:10px;"></audio>
    <h4>📝 Transcribed Text:</h4>
    <textarea id="transcriptionText" rows="4" style="width:100%;"></textarea>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const prescriptionForm = document.getElementById("prescriptionForm");
    const hiddenTranscriptionText = document.getElementById("hiddenTranscriptionText");
    const transcriptionText = document.getElementById("transcriptionText");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const indicator = document.getElementById("recordingIndicator");
    const audioPlayback = document.getElementById("audioPlayback");

    let recognition;
    let mediaRecorder;
    let audioChunks = [];
    let streamReference;

    // --- BUTTON EVENT LISTENERS ---

    // Reloads the page for a new session
    refreshBtn.addEventListener('click', () => {
        location.reload();
    });

    // Before the form submits, copy the transcript text into the hidden field
    prescriptionForm.addEventListener('submit', () => {
        hiddenTranscriptionText.value = transcriptionText.value;
    });

    // --- SPEECH RECOGNITION & RECORDING LOGIC ---

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "en-IN";

        recognition.onresult = (event) => {
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    transcriptionText.value += event.results[i][0].transcript + ' ';
                    transcriptionText.scrollTop = transcriptionText.scrollHeight;
                }
            }
        };
        recognition.onerror = (event) => console.error("Speech Recognition Error:", event.error, event.message);
        recognition.onend = () => console.log("Speech recognition service has disconnected.");
    } else {
        console.warn("Speech Recognition not supported in this browser.");
        startBtn.disabled = true;
        startBtn.textContent = "Browser Not Supported";
    }

    startBtn.addEventListener("click", async () => {
      audioPlayback.src = "";
      transcriptionText.value = "";
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          audioPlayback.src = audioUrl;
        });
        mediaRecorder.start();
        if (recognition) recognition.start();
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        indicator.style.display = "inline-block";
      } catch (err) {
        alert("Microphone access was denied. Please allow microphone access in your browser settings.");
        console.error("Error accessing microphone:", err);
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
      if (recognition) recognition.stop();
      if (streamReference) streamReference.getTracks().forEach(track => track.stop());
      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      indicator.style.display = "none";
    });
  });
</script>
{% endblock %}

