{% extends 'base.html' %}
{% block title %}Prescription - Doctor App{% endblock %}

{% block content %}
<header class="page-header">
  <h1>Capture Conversation üéôÔ∏è</h1>
  <div class="audio-controls">
    <button id="refreshBtn" class="btn btn-secondary">üîÑ New Session</button>
    <button id="startBtn" class="btn record-btn">Start Recording</button>
    <button id="stopBtn" class="btn" style="display:none;">Stop Recording</button>
    <span id="recordingIndicator" class="blink" style="display:none;">üî¥ Recording...</span>
  </div>
</header>

<div class="content-container">
  
  <form id="prescriptionForm" class="card form-card" novalidate>
    {% csrf_token %}
    <div class="form-grid">
      <div class="form-group">
        <label>Patient Name:</label>
        <input type="text" name="patientName" id="patientName" required>
        <span class="error-message" id="nameError"></span>
      </div>

      <div class="form-group">
        <label>Email:</label>
        <input type="email" name="email" id="email" placeholder="patient@example.com">
        <span class="error-message" id="emailError"></span>
      </div>

      <div class="form-group">
        <label>Phone:</label>
        <input type="text" name="phone" id="phone" placeholder="+91..." required>
        <span class="error-message" id="phoneError"></span>
      </div>

      <div class="form-group">
        <label>Age:</label>
        <input type="number" name="age" id="age">
        <span class="error-message" id="ageError"></span>
      </div>

      <div class="form-group">
        <label>Gender:</label>
        <select name="gender"><option>Male</option><option>Female</option><option>Other</option></select>
      </div>

      <div class="form-group">
        <label>Blood Grp:</label>
        <input type="text" name="bloodGrp" id="bloodGrp" placeholder="e.g., A+, O-">
        <span class="error-message" id="bloodGrpError"></span>
      </div>

      <div class="form-group">
        <label>Weight (kg):</label>
        <input type="text" name="weight" id="weight">
        <span class="error-message" id="weightError"></span>
      </div>

      <div class="form-group">
        <label>BP (e.g. 120/80):</label>
        <input type="text" name="bp" id="bp">
        <span class="error-message" id="bpError"></span>
      </div>
      <div class="form-group">
        <label>Allergy:</label>
        <input type="text" name="allergy" id="allergy" placeholder="e.g., Dust, Penicillin">
      </div>
      
      <div class="form-group">
        <label>Severity:</label>
        <select name="severity" id="severity">
          <option value="none">None</option>
          <option value="mild">Mild</option>
          <option value="moderate">Moderate</option>
          <option value="severe">Severe</option>
        </select>
      </div>
      
      <div class="form-group full-width">
        <label>Previous Medication:</label>
        
      
        <div class="history-actions">
          <button class="btn btn-secondary" type="button" id="fetchHistoryBtn">üìú Fetch History</button>
        </div>
      
        <div id="medicationHistory" class="history-box" style="display:none;">
          <h4>Past Medication History:</h4>
          <pre id="historyContent">No history yet.</pre>
        </div>
      </div>
    </div>
    <div style="margin-top: 15px;">
      <textarea id="medicationBox" rows="5" cols="60" placeholder="Medication history or notes will appear here..."></textarea>
    </div>
    
    <div style="margin-top: 10px;">
      <button id="mlHelp">Get ML Help</button>
      <button id="saveMed"> Save / Update Medication</button>

    </div>
    <h3 class="section-title">Symptoms Analysed:</h3>
    <div class="symptom-input-group">
      <input type="text" id="symptomInput" placeholder="Enter symptom and click Add">
      <button class="btn" type="button" id="addSymptomBtn">Add Symptom</button>
    </div>
    <div class="symptoms-list" id="symptomsList"></div>
     
    <h3 class="section-title">Suggested Medicine:</h3>
    <div class="medicine-list" id="medicineList">
        <p style="color: #6b7280; text-align: center;">AI suggestions will appear here.</p>
    </div>

    <div class="action-buttons">
      <button class="btn" type="submit">Verify & Save</button>
      <button id="sendBtn" class="btn btn-secondary" type="button" disabled>Send to Patient</button>
    </div>
    <p id="statusMessage" style="margin-top: 15px; font-weight: 500;"></p>
  </form>

  <div class="card ai-card">
    <h3>Suggested Medicine</h3>
    <div id="aiMedicineList">
       <p>AI suggestions will appear here after analysis.</p>
    </div>
    <hr>
    <h4>üéôÔ∏è Record Result:</h4>
    <audio id="audioPlayback" controls style="width:100%; margin-top:10px;"></audio>
    <h4>üìù Transcribed Text:</h4>
    <textarea id="transcriptionText" rows="6" style="width:100%;"></textarea>
  </div>
</div>

<style>
  .symptoms-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 20px; }
  .symptom-tag { background-color: #e0e7ff; color: #4338ca; padding: 5px 10px; border-radius: 12px; font-size: 0.9em; font-weight: 500; }
  
  /* Styling for the validation error messages */
  .error-message {
    color: #ef4444; /* Red */
    font-size: 0.85em;
    font-weight: 500;
    display: block;
    margin-top: 5px;
    min-height: 1em; /* Prevents layout shifts */
  }
  .form-group input.invalid {
    border-color: #ef4444;
    background-color: #fee2e2;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === Element References ===
    const prescriptionForm = document.getElementById("prescriptionForm");
    const statusMessage = document.getElementById("statusMessage");
    const sendEmailBtn = document.getElementById("sendEmailBtn");
    const symptomInput = document.getElementById("symptomInput");
    const addSymptomBtn = document.getElementById("addSymptomBtn");
    const symptomsList = document.getElementById("symptomsList");
    const medicineList = document.getElementById("medicineList"); // Left side: Doctor's Final List
    const aiMedicineList = document.getElementById("aiMedicineList"); // Right side: AI Suggestions
    const refreshBtn = document.getElementById("refreshBtn");
    const hiddenTranscriptionText = document.getElementById("hiddenTranscriptionText");
    const transcriptionText = document.getElementById("transcriptionText");
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const indicator = document.getElementById("recordingIndicator");
    const audioPlayback = document.getElementById("audioPlayback");
    
    let mediaRecorder, audioChunks = [], streamReference, currentTranscriptionText = "";
    let currentAudioId = null;

    // --- VALIDATION FIELD REFERENCES ---
    const patientName = document.getElementById('patientName');
    const phone = document.getElementById('phone');
    const email = document.getElementById('email');
    const age = document.getElementById('age');
    const bloodGrp = document.getElementById('bloodGrp');
    const weight = document.getElementById('weight');
    const bp = document.getElementById('bp');
    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const phoneError = document.getElementById('phoneError');
    const ageError = document.getElementById('ageError');
    const bloodGrpError = document.getElementById('bloodGrpError');
    const weightError = document.getElementById('weightError');
    const bpError = document.getElementById('bpError');

    // === VALIDATION LOGIC ===
    const validateField = (field, errorElement, validationFn) => {
        const isValid = validationFn(field.value.trim());
        if (!isValid) {
            field.classList.add('invalid');
            errorElement.textContent = field.dataset.errorMessage || 'Invalid input.';
        } else {
            field.classList.remove('invalid');
            errorElement.textContent = '';
        }
        return isValid;
    };

    const isName = (value) => /^[a-zA-Z\s\.']+$/.test(value);
    const isEmail = (value) => value === '' || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    const isPhone = (value) => /^\+?[0-9\s-]{10,15}$/.test(value);
    const isAge = (value) => value === '' || (!isNaN(value) && value > 0 && value < 120);
    const isBloodGroup = (value) => value === '' || /^(A|B|AB|O)[\+-]$/i.test(value);
    const isWeight = (value) => value === '' || (!isNaN(value) && value > 0 && value < 500);
    const isBP = (value) => value === '' || /^\d{2,3}\/\d{2,3}$/.test(value);

    patientName.dataset.errorMessage = 'Please enter a valid name (letters and spaces only).';
    phone.dataset.errorMessage = 'Please enter a valid 10-digit phone number.';
    email.dataset.errorMessage = 'Please enter a valid email address.';
    age.dataset.errorMessage = 'Please enter a valid age.';
    bloodGrp.dataset.errorMessage = 'Valid formats: A+, O-, AB+, etc.';
    weight.dataset.errorMessage = 'Please enter a valid weight in kg.';
    bp.dataset.errorMessage = 'Valid format: 120/80.';

    patientName.addEventListener('input', () => validateField(patientName, nameError, isName));
    phone.addEventListener('input', () => validateField(phone, phoneError, isPhone));
    email.addEventListener('input', () => validateField(email, emailError, isEmail));
    age.addEventListener('input', () => validateField(age, ageError, isAge));
    bloodGrp.addEventListener('input', () => validateField(bloodGrp, bloodGrpError, isBloodGroup));
    weight.addEventListener('input', () => validateField(weight, weightError, isWeight));
    bp.addEventListener('input', () => validateField(bp, bpError, isBP));

    // === SYMPTOM MANAGEMENT ===
    const createSymptomTag = (text, isDeletable = true) => {
        const tag = document.createElement('div');
        tag.className = 'symptom-tag';
        tag.textContent = text;
        if (isDeletable) {
            const removeBtn = document.createElement('span');
            removeBtn.innerHTML = ' &times;';
            removeBtn.style.cursor = 'pointer';
            removeBtn.onclick = () => tag.remove();
            tag.appendChild(removeBtn);
        }
        return tag;
    };

    addSymptomBtn.addEventListener('click', () => {
        const symptomText = symptomInput.value.trim();
        if (symptomText && !document.querySelector(`.symptoms-list > div[data-name="${symptomText}"]`)) {
            const tag = createSymptomTag(symptomText, true);
            tag.dataset.name = symptomText;
            symptomsList.appendChild(tag);
            symptomInput.value = '';
        }
    });

    // === AI ANALYSIS & DISPLAY LOGIC ===

    const renderSuggestions = (symptoms, medicines) => {
        // --- 1. Symptoms (Left Side) ---
        symptomInput.value = ''; 
        
        // Add AI Suggested Symptoms to the Symptoms Analysed list
        symptoms.forEach(s => {
            if (s.name && !document.querySelector(`.symptoms-list > div[data-name="${s.name}"]`)) {
                const tag = createSymptomTag(s.name, true);
                tag.dataset.name = s.name;
                symptomsList.appendChild(tag);
            }
        });

        // --- 2. Medicines (Right Side: AI Suggestion Card) ---
        aiMedicineList.innerHTML = '<h4>AI Suggested Medicines:</h4>';
        medicines.forEach(m => {
            const card = document.createElement('div');
            card.className = 'ai-suggestion-item';
            card.innerHTML = `
                <p><strong>${m.name}</strong> (Confidence: ${(m.confidence * 100).toFixed(0)}%)</p>
                <p style="font-size: 0.9em; color: #6b7280;">Reason: ${m.reason}</p>
                <button class="btn btn-small" data-name="${m.name}" data-type="medicine">Add to Prescription</button>
                <hr style="margin: 10px 0;">
            `;
            aiMedicineList.appendChild(card);
        });
        if (medicines.length === 0) {
            aiMedicineList.innerHTML += '<p style="color: #6b7280;">No medicine suggestions found.</p>';
        }

        // Add event listeners to the new 'Add' buttons
        aiMedicineList.querySelectorAll('button[data-type="medicine"]').forEach(button => {
            button.addEventListener('click', handleAddSuggestion);
        });
    }

    const handleAddSuggestion = (event) => {
        const button = event.target;
        const name = button.dataset.name;
        const type = button.dataset.type;

        if (type === 'medicine') {
            // Add to the FINAL Prescription List (Left Side)
            if (!document.querySelector(`.medicine-list > div[data-name="${name}"]`)) {
                const finalMed = document.createElement('div');
                finalMed.className = 'symptom-tag'; // Reuse style
                finalMed.dataset.name = name;
                finalMed.textContent = name;
                
                const removeBtn = document.createElement('span');
                removeBtn.innerHTML = ' &times;';
                removeBtn.style.cursor = 'pointer';
                removeBtn.onclick = () => finalMed.remove();
                finalMed.appendChild(removeBtn);
                
                medicineList.appendChild(finalMed);
                
                button.textContent = 'Added';
                button.disabled = true;
            }
        }
    };

    const analyzeTranscription = async (text) => {
        aiMedicineList.innerHTML = '<h4>Analyzing...</h4><p>Running LLM analysis for suggestions. Please wait...</p>';
        try {
            // --- CRITICAL: Collect ALL relevant patient context for LLM ---
            const patientContext = {
                name: patientName.value.trim(),
                age: age.value.trim(),
                gender: document.querySelector('[name="gender"]').value,
                weight: weight.value.trim()
            };

            const response = await fetch("{% url 'analyze-prescription' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                // Include text and patient context in the body
                body: JSON.stringify({ 
                    text: text,
                    patient_info: patientContext 
                })
            });

            if (!response.ok) throw new Error(`Analysis failed with status: ${response.status}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                renderSuggestions(data.suggested_symptoms, data.suggested_medicines);
            } else {
                aiMedicineList.innerHTML = `<p style="color: #ef4444;">Error during analysis: ${data.message}</p>`;
            }
        } catch (error) {
            aiMedicineList.innerHTML = `<p style="color: #ef4444;">Analysis Network Error: ${error.message}</p>`;
            console.error('Analysis error:', error);
        }
    };

    // --- SUBMISSION AND EMAIL LOGIC ---

    prescriptionForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        // [KEEP ALL VALIDATION CHECKS]
        const isFormValid = validateField(patientName, nameError, isName) && 
                            validateField(phone, phoneError, isPhone) && 
                            validateField(email, emailError, isEmail) && 
                            validateField(age, ageError, isAge) && 
                            validateField(bloodGrp, bloodGrpError, isBloodGroup) && 
                            validateField(weight, weightError, isWeight) && 
                            validateField(bp, bpError, isBP);

        if (!isFormValid) {
            statusMessage.textContent = 'Please fix the errors before saving.';
            statusMessage.style.color = '#ef4444';
            return;
        }
        
        statusMessage.textContent = 'Verifying and generating PDF...';
        sendEmailBtn.disabled = true;
        
        // --- Prepare Symptoms and Medicines for Submission (FIXED FOR M2M) ---
        const selectedSymptoms = Array.from(symptomsList.querySelectorAll('.symptom-tag'))
                                       .map(tag => tag.dataset.name || tag.textContent.replace(' √ó', '').trim())
                                       .filter(name => name) // Filter out empty strings
                                       .join(',');
                                       
        const selectedMedicines = Array.from(medicineList.querySelectorAll('.symptom-tag'))
                                       .map(tag => tag.dataset.name || tag.textContent.replace(' √ó', '').trim())
                                       .filter(name => name) // Filter out empty strings
                                       .join(',');
                                       
        const formData = new FormData(prescriptionForm);
        formData.append('symptoms_list', selectedSymptoms);
        formData.append('medicines_list', selectedMedicines);
        formData.append('transcriptionText', transcriptionText.value); 
        
        // Add the audio ID if available
        if (currentAudioId) {
            formData.append('audio_id', currentAudioId);
        }

        try {
            const response = await fetch("{% url 'prescription' %}", { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') {
                statusMessage.textContent = data.message + " You can now send the email.";
                statusMessage.style.color = '#10b981';
                sendEmailBtn.dataset.prescriptionId = data.prescription_id;
                sendEmailBtn.disabled = false;
            } else { throw new Error(data.message || 'An unknown error occurred.'); }
        } catch (error) {
            statusMessage.textContent = 'Error: ' + error.message;
            console.error('Form submission error:', error);
        }
    });

    sendEmailBtn.addEventListener('click', async () => {
        const prescriptionId = sendEmailBtn.dataset.prescriptionId;
        if (!prescriptionId) return;
        statusMessage.textContent = 'Sending Email...';
        sendEmailBtn.disabled = true;
        try {
            const response = await fetch(`/send-email/${prescriptionId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') {
                statusMessage.textContent = data.message;
                statusMessage.style.color = '#10b981';
            } else { throw new Error(data.message || 'Failed to send email.'); }
        } catch (error) {
            statusMessage.textContent = 'Error: ' + error.message;
            sendEmailBtn.disabled = false;
        }
    });
    
    // --- FULL RECORDING & TRANSCRIPTION LOGIC ---
    const getTranscription = async (audioBlob) => {
        transcriptionText.value = "Transcribing, please wait...";
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('audio', audioBlob, 'recording.webm');
        try {
            const response = await fetch("{% url 'transcribe-audio' %}", { method: 'POST', body: formData });
            const data = await response.json();
            if (data.status === 'success') {
                currentTranscriptionText = data.text;
                currentAudioId = data.audio_id; // Store the ID of the saved audio record
                transcriptionText.value = currentTranscriptionText;
                
                // --- CRITICAL CALL: Trigger LLM Analysis after Transcription is complete ---
                analyzeTranscription(currentTranscriptionText);
                
            } else { throw new Error(data.message || 'Transcription failed.'); }
        } catch (error) {
            transcriptionText.value = "Error: " + error.message;
        }
    };

    startBtn.addEventListener("click", async () => {
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          audioPlayback.src = URL.createObjectURL(audioBlob);
          getTranscription(audioBlob);
        });
        mediaRecorder.start();
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        indicator.style.display = "inline-block";
        // Reset suggestions
        symptomsList.innerHTML = '';
        medicineList.innerHTML = '<p style="color: #6b7280; text-align: center;">AI suggestions will appear here.</p>';
        aiMedicineList.innerHTML = '<p>AI suggestions will appear here after analysis.</p>';
        currentAudioId = null;
      } catch (err) {
        alert("Microphone access was denied.");
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder) mediaRecorder.stop();
      if (streamReference) streamReference.getTracks().forEach(track => track.stop());
      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      indicator.style.display = "none";
    });
});








// ---------------Fetch Medication History------------------


const fetchBtn = document.getElementById('fetchHistoryBtn');
const saveBtn = document.getElementById('saveMed');
const mlBtn = document.getElementById('mlHelp');
const medBox = document.getElementById('medicationBox');
const phoneInput = document.getElementById('phone');
const patientNameInput = document.getElementById('patientName');

// üîπ Auto-expand textarea height dynamically
medBox.addEventListener("input", () => {
  medBox.style.height = "auto";
  medBox.style.height = medBox.scrollHeight + "px";
});


// üîπ Fetch medication history
fetchBtn.addEventListener("click", async () => {
  const phone = phoneInput.value.trim();
  const patientName = patientNameInput.value.trim();

  if (!phone || !patientName) {
    alert("‚ö†Ô∏è Please enter both patient name and phone number.");
    return;
  }

  fetchBtn.disabled = true;
  fetchBtn.textContent = "Fetching...";

  try {
    const res = await fetch(`/get_previous_medication?phone=${encodeURIComponent(phone)}&patientName=${encodeURIComponent(patientName)}`);
    const data = await res.json();

    if (data.status === "success") {
      medBox.value = data.previous_medication?.trim() || "";
      adjustTextarea();
      alert("‚úÖ Medication record loaded successfully.");
    } else if (data.status === "not_found") {
      medBox.value = "";
      alert("‚ùå No record found for this patient. You can add a new one below.");
    } else {
      alert(`‚ö†Ô∏è Error: ${data.message || "Something went wrong"}`);
    }
  } catch (err) {
    console.error("Fetch error:", err);
    alert("üö´ Error fetching data. Check network or server.");
  } finally {
    fetchBtn.textContent = "Fetch Medication";
    fetchBtn.disabled = false;
  }
});


// üîπ Add ML suggestion into the same box
mlBtn.addEventListener("click", async () => {
  medBox.value += `\n\nüí° Suggested by ML: Continue dosage for 5 days.`;
  adjustTextarea();
});


// üîπ Save / Update medication info
saveBtn.addEventListener("click", async () => {
  const phone = phoneInput.value.trim();
  const patientName = patientNameInput.value.trim();
  const medicationText = medBox.value.trim();

  if (!phone || !patientName) {
    alert("‚ö†Ô∏è Please enter patient name and phone number.");
    return;
  }
  if (!medicationText) {
    alert("‚ö†Ô∏è Medication field is empty.");
    return;
  }

  const formData = new FormData();
  formData.append("phone", phone);
  formData.append("patientName", patientName);
  formData.append("currentMedication", medicationText);

  try {
    const res = await fetch("/update_medication", { method: "POST", body: formData });
    const data = await res.json();

    if (data.status === "success") {
      alert("‚úÖ Medication updated successfully.");
    } else {
      alert(`‚ùå Failed: ${data.message}`);
    }
  } catch (err) {
    console.error("Save error:", err);
    alert("üö´ Error saving medication record.");
  }
});


// Helper to auto-resize textarea
function adjustTextarea() {
  medBox.style.height = "auto";
  medBox.style.height = medBox.scrollHeight + "px";
}


// -----------------------------------------
</script>
{% endblock %}

