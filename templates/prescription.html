{% extends 'base.html' %}
{% block title %}Prescription - Doctor App{% endblock %}

{% block content %}
<header class="page-header">
  <h1>Capture Conversation üéôÔ∏è</h1>
  <div class="audio-controls">
    <button id="refreshBtn" class="btn btn-secondary">üîÑ New Session</button>
    <button id="startBtn" class="btn record-btn">Start Recording</button>
    <button id="stopBtn" class="btn" style="display:none;">Stop Recording</button>
    <span id="recordingIndicator" class="blink" style="display:none;">üî¥ Recording...</span>
  </div>
</header>

<div class="content-container">
  
  <form id="prescriptionForm" class="card form-card" novalidate>
    {% csrf_token %}
    <div class="form-grid">
      <div class="form-group">
        <label>Patient Name:</label>
        <input type="text" name="patientName" id="patientName" required>
        <span class="error-message" id="nameError"></span>
      </div>

      <div class="form-group">
        <label>Email:</label>
        <input type="email" name="email" id="email" placeholder="patient@example.com">
        <span class="error-message" id="emailError"></span>
      </div>

      <div class="form-group">
        <label>Phone:</label>
        <input type="text" name="phone" id="phone" placeholder="+91..." required>
        <span class="error-message" id="phoneError"></span>
      </div>

      <div class="form-group">
        <label>Age:</label>
        <input type="number" name="age" id="age">
        <span class="error-message" id="ageError"></span>
      </div>

      <div class="form-group">
        <label>Gender:</label>
        <select name="gender"><option>Male</option><option>Female</option><option>Other</option></select>
      </div>

      <div class="form-group">
        <label>Blood Grp:</label>
        <input type="text" name="bloodGrp" id="bloodGrp" placeholder="e.g., A+, O-">
        <span class="error-message" id="bloodGrpError"></span>
      </div>

      <div class="form-group">
        <label>Weight (kg):</label>
        <input type="text" name="weight" id="weight">
        <span class="error-message" id="weightError"></span>
      </div>

      <div class="form-group">
        <label>BP (e.g. 120/80):</label>
        <input type="text" name="bp" id="bp">
        <span class="error-message" id="bpError"></span>
      </div>
    </div>
    <input type="hidden" name="transcriptionText" id="hiddenTranscriptionText">
    <input type="hidden" name="confirmedSymptoms" id="confirmedSymptoms"> <h3 class="section-title">Symptoms Analysed:</h3>
    
    <div class="symptom-input-group" style="margin-bottom: 10px;">
      <button class="btn btn-secondary" type="button" id="predictSymptomsBtn">üß† Get AI Symptoms</button>
      <span id="symptomStatus" style="margin-left: 15px; font-style: italic;"></span>
    </div>

    <div id="aiSymptomOptions" class="ai-symptom-options">
      <p style="color: #6b7280; text-align: center;">Click 'Get AI Symptoms' after transcription is complete.</p>
    </div>
    
    <h4 style="margin-top: 20px; border-bottom: none;">Confirmed Symptoms:</h4>
    <div class="symptoms-list" id="symptomsList">
       </div>
    <div class="symptom-input-group" style="margin-top: 15px;">
      <input type="text" id="symptomInput" placeholder="Add custom symptom and click Add">
      <button class="btn" type="button" id="addSymptomBtn">Add Symptom</button>
    </div>
    <h3 class="section-title">Suggested Medicine:</h3>
    <div class="medicine-list" id="medicineList">
        <p style="color: #6b7280; text-align: center;">AI suggestions will appear here.</p>
    </div>

    <div class="action-buttons">
      <button class="btn" type="submit">‚úçÔ∏è Verify & Save</button>
      <button id="sendEmailBtn" class="btn btn-secondary" type="button" disabled>üìß Send Email</button>
    </div>
    <p id="statusMessage" style="margin-top: 15px; font-weight: 500;"></p>
  </form>

  <div class="card ai-card">
    <h3>Suggested Medicine</h3>
    <div id="aiMedicineList">
       <p>AI suggestions will appear here after analysis.</p>
    </div>
    <hr>
    <h4>üéôÔ∏è Record Result:</h4>
    <audio id="audioPlayback" controls style="width:100%; margin-top:10px;"></audio>
    <h4>üìù Transcribed Text:</h4>
    <textarea id="transcriptionText" rows="6" style="width:100%;"></textarea>
  </div>
</div>

<style>
  .symptoms-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 20px; }
  .symptom-tag { 
    background-color: #e0e7ff; 
    color: #4338ca; 
    padding: 5px 10px; 
    border-radius: 12px; 
    font-size: 0.9em; 
    font-weight: 500; 
    position: relative;
    cursor: pointer;
  }
  .symptom-tag.confirmed {
    background-color: #10b981; /* Green for confirmed */
    color: white;
    cursor: default;
  }
  .symptom-tag .remove-btn {
    margin-left: 8px;
    color: #4338ca;
    cursor: pointer;
    font-weight: 700;
  }
  .symptom-tag.confirmed .remove-btn {
    color: white;
  }
  .ai-symptom-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    border: 1px dashed #d1d5db;
    border-radius: 8px;
    min-height: 50px;
  }
  .ai-symptom-option {
    background-color: #f3f4f6;
    color: #4b5563;
    padding: 5px 10px;
    border-radius: 12px;
    font-size: 0.9em;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .ai-symptom-option:hover {
    background-color: #e5e7eb;
    color: #1f2937;
  }

  /* Styling for the validation error messages */
  .error-message {
    color: #ef4444; /* Red */
    font-size: 0.85em;
    font-weight: 500;
    display: block;
    margin-top: 5px;
    min-height: 1em; /* Prevents layout shifts */
  }
  .form-group input.invalid {
    border-color: #ef4444;
    background-color: #fee2e2;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === Element References ===
    const prescriptionForm = document.getElementById("prescriptionForm");
    const statusMessage = document.getElementById("statusMessage");
    const sendEmailBtn = document.getElementById("sendEmailBtn");
    const symptomInput = document.getElementById("symptomInput");
    const addSymptomBtn = document.getElementById("addSymptomBtn");
    const symptomsList = document.getElementById("symptomsList");
    const refreshBtn = document.getElementById("refreshBtn");
    const hiddenTranscriptionText = document.getElementById("hiddenTranscriptionText");
    const transcriptionText = document.getElementById("transcriptionText");
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const indicator = document.getElementById("recordingIndicator");
    const audioPlayback = document.getElementById("audioPlayback");
    const predictSymptomsBtn = document.getElementById("predictSymptomsBtn"); 
    const aiSymptomOptions = document.getElementById("aiSymptomOptions");     
    const symptomStatus = document.getElementById("symptomStatus");           
    const confirmedSymptomsField = document.getElementById("confirmedSymptoms"); 

    let mediaRecorder, audioChunks = [], streamReference;
    let confirmedSymptoms = new Set(); // Stores confirmed symptoms for submission

    // --- VALIDATION FIELD REFERENCES ---
    const patientName = document.getElementById('patientName');
    const email = document.getElementById('email');
    const phone = document.getElementById('phone');
    const age = document.getElementById('age');
    const bloodGrp = document.getElementById('bloodGrp');
    const weight = document.getElementById('weight');
    const bp = document.getElementById('bp');
    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const phoneError = document.getElementById('phoneError');
    const ageError = document.getElementById('ageError');
    const bloodGrpError = document.getElementById('bloodGrpError');
    const weightError = document.getElementById('weightError');
    const bpError = document.getElementById('bpError');

    // === VALIDATION LOGIC ===
    const validateField = (field, errorElement, validationFn) => {
        const isValid = validationFn(field.value.trim());
        if (!isValid) {
            field.classList.add('invalid');
            errorElement.textContent = field.dataset.errorMessage || 'Invalid input.';
        } else {
            field.classList.remove('invalid');
            errorElement.textContent = '';
        }
        return isValid;
    };

    const isName = (value) => /^[a-zA-Z\s\.']+$/.test(value);
    const isEmail = (value) => value === '' || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    const isPhone = (value) => /^\+?[0-9\s-]{10,15}$/.test(value);
    const isAge = (value) => value === '' || (!isNaN(value) && value > 0 && value < 120);
    const isBloodGroup = (value) => value === '' || /^(A|B|AB|O)[\+-]$/i.test(value);
    const isWeight = (value) => value === '' || (!isNaN(value) && value > 0 && value < 500);
    const isBP = (value) => value === '' || /^\d{2,3}\/\d{2,3}$/.test(value);

    patientName.dataset.errorMessage = 'Please enter a valid name (letters and spaces only).';
    phone.dataset.errorMessage = 'Please enter a valid 10-digit phone number.';
    email.dataset.errorMessage = 'Please enter a valid email address.';
    age.dataset.errorMessage = 'Please enter a valid age.';
    bloodGrp.dataset.errorMessage = 'Valid formats: A+, O-, AB+, etc.';
    weight.dataset.errorMessage = 'Please enter a valid weight in kg.';
    bp.dataset.errorMessage = 'Valid format: 120/80.';

    patientName.addEventListener('input', () => validateField(patientName, nameError, isName));
    phone.addEventListener('input', () => validateField(phone, phoneError, isPhone));
    email.addEventListener('input', () => validateField(email, emailError, isEmail));
    age.addEventListener('input', () => validateField(age, ageError, isAge));
    bloodGrp.addEventListener('input', () => validateField(bloodGrp, bloodGrpError, isBloodGroup));
    weight.addEventListener('input', () => validateField(weight, weightError, isWeight));
    bp.addEventListener('input', () => validateField(bp, bpError, isBP));

    // === SYMPTOM MANAGEMENT FUNCTIONS ===

    const renderConfirmedSymptoms = () => {
        symptomsList.innerHTML = '';
        // Update hidden field with comma-separated list for form submission
        confirmedSymptomsField.value = Array.from(confirmedSymptoms).join(','); 

        confirmedSymptoms.forEach(symptomText => {
            const symptomTag = document.createElement('div');
            symptomTag.className = 'symptom-tag confirmed';
            symptomTag.innerHTML = `${symptomText} <span class="remove-btn">x</span>`;
            
            symptomTag.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                confirmedSymptoms.delete(symptomText);
                renderConfirmedSymptoms();
            });

            symptomsList.appendChild(symptomTag);
        });
    }

    const addSymptom = (text) => {
        const symptomText = text.trim();
        // Capitalize for consistency
        const capitalizedText = symptomText.charAt(0).toUpperCase() + symptomText.slice(1).toLowerCase();
        
        if (capitalizedText && !confirmedSymptoms.has(capitalizedText)) {
            confirmedSymptoms.add(capitalizedText);
            renderConfirmedSymptoms();
        }
    }

    // Add Custom Symptom Button Handler
    addSymptomBtn.addEventListener('click', () => {
        addSymptom(symptomInput.value);
        symptomInput.value = '';
    });

    // === NEW: GET AI SYMPTOMS LOGIC ===
    predictSymptomsBtn.addEventListener('click', async () => {
        const text = transcriptionText.value.trim();
        if (!text) {
            symptomStatus.textContent = 'Please complete the recording and transcription first.';
            symptomStatus.style.color = '#f59e0b';
            return;
        }

        symptomStatus.textContent = 'Analyzing text for symptoms...';
        symptomStatus.style.color = '#3b82f6';
        aiSymptomOptions.innerHTML = '';
        
        // Collect necessary patient info
        const patientData = {
            transcribed_text: text,
            age: age.value,
            gender: document.querySelector('[name="gender"]').value,
            weight: weight.value
        };

        try {
            const response = await fetch("{% url 'predict-symptoms' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(patientData)
            });

            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();

            if (data.status === 'success') {
                symptomStatus.textContent = `Found ${data.symptoms.length} potential symptoms. Click to confirm.`;
                symptomStatus.style.color = '#10b981';
                
                if (data.symptoms.length === 0) {
                     aiSymptomOptions.innerHTML = '<p style="color: #6b7280; text-align: center;">No specific symptoms were extracted by the AI.</p>';
                     return;
                }

                data.symptoms.forEach(symptom => {
                    const option = document.createElement('div');
                    option.className = 'ai-symptom-option';
                    option.textContent = symptom;
                    option.title = "Click to add to confirmed list";
                    // Click handler for AI symptom options
                    option.addEventListener('click', () => {
                        addSymptom(symptom);
                        option.style.display = 'none'; // Hide option after clicking it
                    });
                    aiSymptomOptions.appendChild(option);
                });

            } else { 
                throw new Error(data.message || 'AI analysis failed.'); 
            }
        } catch (error) {
            symptomStatus.textContent = 'Error during AI analysis: ' + error.message;
            symptomStatus.style.color = '#ef4444';
            aiSymptomOptions.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading suggestions.</p>';
            console.error('AI Symptom Prediction Error:', error);
        }
    });

    // === Original Form Submission Logic ===
    prescriptionForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Check form validity
        const isNameValid = validateField(patientName, nameError, isName);
        const isPhoneValid = validateField(phone, phoneError, isPhone);
        const isEmailValid = validateField(email, emailError, isEmail);
        const isAgeValid = validateField(age, ageError, isAge);
        const isBloodGroupValid = validateField(bloodGrp, bloodGrpError, isBloodGroup);
        const isWeightValid = validateField(weight, weightError, isWeight);
        const isBPValid = validateField(bp, bpError, isBP);

        if (!isNameValid || !isPhoneValid || !isEmailValid || !isAgeValid || !isBloodGroupValid || !isWeightValid || !isBPValid) {
            statusMessage.textContent = 'Please fix the errors before saving.';
            statusMessage.style.color = '#ef4444';
            return;
        }
        
        statusMessage.textContent = 'Verifying and generating PDF...';
        sendEmailBtn.disabled = true;
        
        // Ensure hidden fields are updated right before submission
        hiddenTranscriptionText.value = transcriptionText.value;
        confirmedSymptomsField.value = Array.from(confirmedSymptoms).join(','); // IMPORTANT
        
        const formData = new FormData(prescriptionForm);
        try {
            const response = await fetch("{% url 'prescription' %}", { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') {
                statusMessage.textContent = data.message + " You can now send the email.";
                statusMessage.style.color = '#10b981';
                sendEmailBtn.dataset.prescriptionId = data.prescription_id;
                sendEmailBtn.disabled = false;
            } else { throw new Error(data.message || 'An unknown error occurred.'); }
        } catch (error) {
            statusMessage.textContent = 'Error: ' + error.message;
            console.error('Form submission error:', error);
        }
    });

    // ... (Original sendEmailBtn logic remains the same) ...

    sendEmailBtn.addEventListener('click', async () => {
        const prescriptionId = sendEmailBtn.dataset.prescriptionId;
        if (!prescriptionId) return;
        statusMessage.textContent = 'Sending Email...';
        sendEmailBtn.disabled = true;
        try {
            const response = await fetch(`/send-email/${prescriptionId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') {
                statusMessage.textContent = data.message;
                statusMessage.style.color = '#10b981';
            } else { throw new Error(data.message || 'Failed to send email.'); }
        } catch (error) {
            statusMessage.textContent = 'Error: ' + error.message;
            sendEmailBtn.disabled = false;
        }
    });
    
    // --- FULL RECORDING & TRANSCRIPTION LOGIC ---
    const getTranscription = async (audioBlob) => {
        transcriptionText.value = "Transcribing, please wait...";
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('audio', audioBlob, 'recording.webm');
        try {
            const response = await fetch("{% url 'transcribe-audio' %}", { method: 'POST', body: formData });
            const data = await response.json();
            if (data.status === 'success') {
                transcriptionText.value = data.text;
                // NEW: Automatically prompt for AI symptoms after successful transcription
                predictSymptomsBtn.click(); 
            } else { throw new Error(data.message || 'Transcription failed.'); }
        } catch (error) {
            transcriptionText.value = "Error: " + error.message;
        }
    };

    startBtn.addEventListener("click", async () => {
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamReference = stream;
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          audioPlayback.src = URL.createObjectURL(audioBlob);
          getTranscription(audioBlob);
        });
        mediaRecorder.start();
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        indicator.style.display = "inline-block";
      } catch (err) {
        alert("Microphone access was denied.");
      }
    });



    // === NEW SESSION (REFRESH) BUTTON LOGIC ===
    refreshBtn.addEventListener('click', () => {
    // Stop any ongoing recording
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    if (streamReference) {
        streamReference.getTracks().forEach(track => track.stop());
    }

    // Reset form fields and data
    audioChunks = [];
    audioPlayback.src = '';
    transcriptionText.value = '';
    hiddenTranscriptionText.value = '';
    aiSymptomOptions.innerHTML = '<p style="color: #6b7280; text-align: center;">Click \'Get AI Symptoms\' after transcription is complete.</p>';
    symptomStatus.textContent = '';
    confirmedSymptoms.clear();
    renderConfirmedSymptoms();
    symptomInput.value = '';
    statusMessage.textContent = '';

    // Reset button visibility
    startBtn.style.display = "inline-block";
    stopBtn.style.display = "none";
    indicator.style.display = "none";
    sendEmailBtn.disabled = true;

    // Visual feedback
    refreshBtn.textContent = "üîÑ Session Cleared!";
    refreshBtn.style.color = "#10b981";
    setTimeout(() => {
        refreshBtn.textContent = "üîÑ New Session";
        refreshBtn.style.color = "";
    }, 1500);
});


    stopBtn.addEventListener("click", () => {
      if (mediaRecorder) mediaRecorder.stop();
      if (streamReference) streamReference.getTracks().forEach(track => track.stop());
      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      indicator.style.display = "none";
    });

    // Initial render of confirmed symptoms list (should be empty initially)
    renderConfirmedSymptoms();
});
</script>
{% endblock %}